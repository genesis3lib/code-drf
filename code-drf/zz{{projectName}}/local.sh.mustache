#!/bin/bash
#
# Local Development Startup Script
# Generated by Genesis3 for {{{projectName}}}
#
# This script starts all services needed for local development:
# - PostgreSQL database (via Docker)
# - Django/DRF backend
# - Frontend (if available)
#
# Usage: ./local.sh
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
PROJECT_NAME="{{{projectName}}}"

# Module directories
BACKEND_DIR="$PROJECT_ROOT/{{{backendModule.moduleId}}}"
{{#hasFrontend}}
FRONTEND_DIR="$PROJECT_ROOT/{{{frontendModule.moduleId}}}"
{{/hasFrontend}}

# Ports
BACKEND_PORT=8080
{{#hasFrontend}}
FRONTEND_PORT=5173
{{/hasFrontend}}
DB_PORT=5432

# PID file location
PID_DIR="$SCRIPT_DIR/.pids"
BACKEND_PID_FILE="$PID_DIR/backend.pid"
{{#hasFrontend}}
FRONTEND_PID_FILE="$PID_DIR/frontend.pid"
{{/hasFrontend}}

# Log file location
LOG_DIR="$SCRIPT_DIR/.logs"
BACKEND_LOG="$LOG_DIR/backend.log"
{{#hasFrontend}}
FRONTEND_LOG="$LOG_DIR/frontend.log"
{{/hasFrontend}}

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_header() {
    echo ""
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}========================================${NC}"
}

print_success() {
    echo -e "${GREEN}[OK]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

# Check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check if a port is in use
port_in_use() {
    lsof -i ":$1" >/dev/null 2>&1
}

# Wait for a port to become available
wait_for_port() {
    local port=$1
    local max_attempts=${2:-30}
    local attempt=0

    while [ $attempt -lt $max_attempts ]; do
        if port_in_use "$port"; then
            return 0
        fi
        sleep 1
        attempt=$((attempt + 1))
    done
    return 1
}

# Check prerequisites
check_prerequisites() {
    print_header "Checking Prerequisites"

    local missing=()

    # Check Docker
    if command_exists docker; then
        if docker info >/dev/null 2>&1; then
            print_success "Docker is installed and running"
        else
            print_error "Docker is installed but not running"
            echo "         Please start Docker Desktop and try again"
            exit 1
        fi
    else
        missing+=("docker")
        print_error "Docker is not installed"
        echo "         Install from: https://docs.docker.com/get-docker/"
    fi

    # Check Python
    if command_exists python3; then
        local py_version=$(python3 --version 2>&1 | grep -oE '[0-9]+\.[0-9]+')
        local py_major=$(echo "$py_version" | cut -d. -f1)
        local py_minor=$(echo "$py_version" | cut -d. -f2)

        if [ "$py_major" -ge 3 ] && [ "$py_minor" -ge 10 ]; then
            print_success "Python $py_version is installed (required: 3.10+)"
        else
            print_warning "Python $py_version found, but 3.10+ recommended"
        fi
    else
        missing+=("python3")
        print_error "Python 3 is not installed"
        echo "         Install from: https://www.python.org/downloads/"
        echo "         Or use: brew install python@3.12 (macOS)"
    fi

{{#hasFrontend}}
    # Check Node.js
    if command_exists node; then
        local node_version=$(node --version | grep -oE '[0-9]+' | head -1)
        if [ "$node_version" -ge 18 ]; then
            print_success "Node.js v$(node --version | tr -d 'v') is installed (required: 18+)"
        else
            print_warning "Node.js v$(node --version | tr -d 'v') found, but 18+ recommended"
        fi
    else
        missing+=("node")
        print_error "Node.js is not installed"
        echo "         Install from: https://nodejs.org/"
        echo "         Or use: brew install node (macOS)"
        echo "         Or use: nvm install 20 (with nvm)"
    fi

    # Check npm
    if ! command_exists npm; then
        missing+=("npm")
        print_error "npm is not installed"
        echo "         npm comes with Node.js installation"
    fi
{{/hasFrontend}}

    if [ ${#missing[@]} -gt 0 ]; then
        echo ""
        print_error "Missing prerequisites: ${missing[*]}"
        echo "         Please install the missing tools and try again"
        exit 1
    fi

    echo ""
    print_success "All prerequisites satisfied"
}

# Check for required environment variables
check_env_vars() {
    print_header "Checking Environment Variables"

{{#hasFrontend}}
    # Check frontend env
    if [ -f "$FRONTEND_DIR/.env" ]; then
        print_success "Frontend .env file exists"

        # Check for Auth0 variables if using Auth0
        if ! grep -q "VITE_AUTH0_CLIENT_ID" "$FRONTEND_DIR/.env" || \
           grep -q "VITE_AUTH0_CLIENT_ID=$" "$FRONTEND_DIR/.env"; then
            print_warning "VITE_AUTH0_CLIENT_ID not set in $FRONTEND_DIR/.env"
            echo "         Add: VITE_AUTH0_CLIENT_ID=your_auth0_client_id"
        fi
    else
        print_warning "Frontend .env file not found at $FRONTEND_DIR/.env"
        echo "         Copy .env.dev to .env and update values"
    fi
{{/hasFrontend}}

    # Backend uses DATABASE_URL from docker-compose or environment
    print_info "Backend will use DATABASE_URL from docker-compose environment"
}

# Start PostgreSQL via Docker
start_database() {
    print_header "Starting Database"

    if port_in_use $DB_PORT; then
        print_warning "Port $DB_PORT already in use - assuming PostgreSQL is running"
        return 0
    fi

    print_info "Starting PostgreSQL via Docker Compose..."

    (cd "$SCRIPT_DIR" && docker compose up -d postgres 2>&1)

    # Wait for PostgreSQL to be ready
    print_info "Waiting for PostgreSQL to be ready..."
    local max_attempts=30
    local attempt=0

    while [ $attempt -lt $max_attempts ]; do
        if docker compose -f "$SCRIPT_DIR/docker-compose.yaml" exec -T postgres pg_isready -U {{{projectName}}}_user -d {{{projectName}}} >/dev/null 2>&1; then
            print_success "PostgreSQL is ready on port $DB_PORT"
            return 0
        fi
        sleep 1
        attempt=$((attempt + 1))
        echo -n "."
    done

    echo ""
    print_error "PostgreSQL failed to start within 30 seconds"
    exit 1
}

# Setup Python virtual environment and install dependencies
setup_backend() {
    print_header "Setting Up Backend"

    if [ ! -d "$BACKEND_DIR" ]; then
        print_warning "Backend directory not found: $BACKEND_DIR"
        return 1
    fi

    # Create venv if it doesn't exist
    if [ ! -d "$BACKEND_DIR/venv" ]; then
        print_info "Creating Python virtual environment..."
        (cd "$BACKEND_DIR" && python3 -m venv venv)
        print_success "Virtual environment created"
    else
        print_success "Virtual environment exists"
    fi

    # Install/update dependencies
    print_info "Installing Python dependencies..."
    (cd "$BACKEND_DIR" && source venv/bin/activate && pip install -q -r requirements.txt)
    print_success "Python dependencies installed"

    # Run migrations
    print_info "Running database migrations..."
    (cd "$BACKEND_DIR" && source venv/bin/activate && \
        DATABASE_URL="postgresql://{{{projectName}}}_user:localdev@localhost:5432/{{{projectName}}}" \
        DJANGO_SETTINGS_MODULE="prj_{{{projectName}}}.settings.dev" \
        python manage.py migrate --no-input 2>&1)
    print_success "Database migrations complete"
}

{{#hasFrontend}}
# Setup frontend and install dependencies
setup_frontend() {
    print_header "Setting Up Frontend"

    if [ ! -d "$FRONTEND_DIR" ]; then
        print_warning "Frontend directory not found: $FRONTEND_DIR"
        return 1
    fi

    # Install npm dependencies if node_modules doesn't exist or package.json is newer
    if [ ! -d "$FRONTEND_DIR/node_modules" ] || \
       [ "$FRONTEND_DIR/package.json" -nt "$FRONTEND_DIR/node_modules" ]; then
        print_info "Installing npm dependencies..."
        (cd "$FRONTEND_DIR" && npm install --silent)
        print_success "npm dependencies installed"
    else
        print_success "npm dependencies up to date"
    fi
}
{{/hasFrontend}}

# Start backend server
start_backend() {
    print_header "Starting Backend Server"

    if [ ! -d "$BACKEND_DIR" ]; then
        print_warning "Backend directory not found - skipping"
        return 0
    fi

    if port_in_use $BACKEND_PORT; then
        print_warning "Port $BACKEND_PORT already in use - backend may already be running"
        echo "         Run ./kill-local.sh to stop existing services"
        return 0
    fi

    # Create directories
    mkdir -p "$PID_DIR" "$LOG_DIR"

    print_info "Starting Django development server on port $BACKEND_PORT..."

    (cd "$BACKEND_DIR" && \
        source venv/bin/activate && \
        DATABASE_URL="postgresql://{{{projectName}}}_user:localdev@localhost:5432/{{{projectName}}}" \
        DJANGO_SETTINGS_MODULE="prj_{{{projectName}}}.settings.dev" \
        nohup python manage.py runserver 0.0.0.0:$BACKEND_PORT > "$BACKEND_LOG" 2>&1 &
        echo $! > "$BACKEND_PID_FILE"
    )

    # Wait for backend to start
    if wait_for_port $BACKEND_PORT 15; then
        print_success "Backend started on http://localhost:$BACKEND_PORT"
        print_info "Backend logs: $BACKEND_LOG"
    else
        print_error "Backend failed to start. Check logs: $BACKEND_LOG"
        if [ -f "$BACKEND_LOG" ]; then
            echo "         Last 10 lines of log:"
            tail -10 "$BACKEND_LOG" | sed 's/^/         /'
        fi
    fi
}

{{#hasFrontend}}
# Start frontend server
start_frontend() {
    print_header "Starting Frontend Server"

    if [ ! -d "$FRONTEND_DIR" ]; then
        print_warning "Frontend directory not found - skipping"
        return 0
    fi

    if port_in_use $FRONTEND_PORT; then
        print_warning "Port $FRONTEND_PORT already in use - frontend may already be running"
        echo "         Run ./kill-local.sh to stop existing services"
        return 0
    fi

    # Create directories
    mkdir -p "$PID_DIR" "$LOG_DIR"

    print_info "Starting Vite development server on port $FRONTEND_PORT..."

    (cd "$FRONTEND_DIR" && \
        nohup npm run dev > "$FRONTEND_LOG" 2>&1 &
        echo $! > "$FRONTEND_PID_FILE"
    )

    # Wait for frontend to start
    if wait_for_port $FRONTEND_PORT 30; then
        print_success "Frontend started on http://localhost:$FRONTEND_PORT"
        print_info "Frontend logs: $FRONTEND_LOG"
    else
        print_error "Frontend failed to start. Check logs: $FRONTEND_LOG"
        if [ -f "$FRONTEND_LOG" ]; then
            echo "         Last 10 lines of log:"
            tail -10 "$FRONTEND_LOG" | sed 's/^/         /'
        fi
    fi
}
{{/hasFrontend}}

# Print summary
print_summary() {
    print_header "Development Environment Ready"

    echo ""
    echo -e "${GREEN}Services:${NC}"

    if port_in_use $DB_PORT; then
        echo -e "  ${GREEN}PostgreSQL${NC}  http://localhost:$DB_PORT"
    fi

    if port_in_use $BACKEND_PORT; then
        echo -e "  ${GREEN}Backend API${NC} http://localhost:$BACKEND_PORT"
        echo -e "              http://localhost:$BACKEND_PORT/api/v1/public/health"
        echo -e "              http://localhost:$BACKEND_PORT/api/schema/swagger-ui/"
    fi

{{#hasFrontend}}
    if port_in_use $FRONTEND_PORT; then
        echo -e "  ${GREEN}Frontend${NC}    http://localhost:$FRONTEND_PORT"
    fi
{{/hasFrontend}}

    echo ""
    echo -e "${YELLOW}Logs:${NC}"
    echo "  Backend:  $BACKEND_LOG"
{{#hasFrontend}}
    echo "  Frontend: $FRONTEND_LOG"
{{/hasFrontend}}

    echo ""
    echo -e "${YELLOW}Commands:${NC}"
    echo "  Stop all services:  ./kill-local.sh"
    echo "  View backend logs:  tail -f $BACKEND_LOG"
{{#hasFrontend}}
    echo "  View frontend logs: tail -f $FRONTEND_LOG"
{{/hasFrontend}}
    echo ""
}

# Main execution
main() {
    echo ""
    echo -e "${BLUE}Starting local development environment for ${PROJECT_NAME}${NC}"
    echo ""

    check_prerequisites
    check_env_vars
    start_database
    setup_backend
{{#hasFrontend}}
    setup_frontend
    start_frontend
{{/hasFrontend}}
    start_backend
    print_summary
}

main "$@"
